---
title: Hadoop | The Definitive Guide 02
date: 2021-03-18 09:29:00
categories:
 - hadoop
tag:
 - hadoop
---

# 1장 하둡 기초

## Part 2. 맵리듀스

맵리듀스는 데이터 처리를 위한 프로그래밍 모델이다. 자바, 루비, 파이썬으로 작성된 동일한 프로그램을 살펴보면서 예제를 통해 맵리듀스의 프로그래밍 모델을 살펴보자

### 2.1 기상 데이터셋

기상데이터는 반구조적(semi-structured), 레코드 지향적(record-oriented)이기 때문에 맵리듀스 이용 데이터 분석에 적합하다.

#### 2.1.1 데이터 포맷

예시 데이터는  국립기후자료센터[NCDC, National Climatic Data Center](www.ncdc.noaa.gov) 에서 가져와 사용한다.

- 한행이 하나의 레코드, 행 단위 아스키 형식
- 단순 처리를 위해 고정길이의 기온과 같은 기본 요소에 초점

데이터 예시)

```bash
0057
332130     # USAF 기상관측소 식별자
99999      # WBAN 기상관측소 식별자
19500101   # 관측 날짜
0300       # 관측 시간
4
+51317     # 위도 (위도 * 1000)
+028783    # 경도 (경도 * 1000)
FM-12
+0171      # 고도 (미터)
99999
V020
320        # 바람 방향 (도)
1          # 특성 코드 0,1,4,5,9
N
...
```



국립기후자료센터에서 데이터 파일은 해당 날짜와 기상 관측소 기준으로 분리되어 연도별 디렉터리에 위치한다.

```bash
$ ls raw/1990 | head
010010-99999-1990.gz
010014-99999-1990.gz
010015-99999-1990.gz
010016-99999-1990.gz
010017-99999-1990.gz
010030-99999-1990.gz
```

수만 개의 기상관측소가 존재하기 때문에 전체 데이터셋은 상대적으로 작은 파일이 매우 많다. 하둡의 특성상 소수의 큰 파일이 처리하기 쉽고 효율적이다. 따라서 다수의 파일을 특정 기준으로 병합하기 위해 먼저 전처리 작업을 해야 한다.

### 2.2 유닉스 도구로 데이터 분석하기

**Q. 연도별 전 세계 최고 기온은 얼마일까?**

- **유닉스 도구로만 분석하기**

```bash
#!/usr/bin/env bash
for year in *
do
	echo -ne `basename $year .gz`"\t"
	gunzip -c $year | \
		awk '{temp = substr($0, 88, 5) + 0;
			  q = substr($0, 93, 1);
			  if (temp !=9999 && q ~ /[01459]/ && temp > max) max = temp }
			  END { print max }'
done
```

1) 연도별 파일을 돌면서 해당 연도 출력

2) awk 이용 각 파일 처리 (데이터에서 기온 **temp**, 특성코드 **q** 추출)

3) 기온에 + 0 하여 그 값을 정수형으로 변환

4) 기온이 유효한 값인지(9999는 누락값을 의미), 특성코드로 데이터 신뢰 가능인지 체크

5) 현재 최고 기온과 비교하여 높은 값을 최고 기온으로 변경

6) END영역은 파일의 모든 행이 처리된 후에 실행되는데, 최종 최고기온을 출력

스크립트 실행 결과 예시

```bash
1901 317
1902 244
1903 289
1904 256
1905 283
...
```

##### 생각해볼 점

1. 일을 동일한 크기로 나누는 것이 언제나 쉽고 명확할 수 없다.
   - 전체 입력 파일을 고정길이 데이터 청크로 나누고 각 청크를 하나의 프로세스에 할당
2. 독립적인 프로세스 결과를 모두 합치는데 더 많은 처리가 필요할 수 있다.
3. 단일 머신 처리 능력에 한계가 있다.
   - 여러 대의 머신을 사용할 때는 코디네이션(Coordination,협력과 조정)과 신뢰성 고민이 필요하다.

### 2.3 하둡으로 데이터 분석하기

하둡의 병렬처리를 활용하기 위해 맵리듀스로 다시 표현할 필요가 있다.

#### 2.3.1 맵과 리듀스

맵리듀스 작업은 크게 맵 단계와 리듀스 단계로 구분된다. 각 단계는 입력과 출력으로 키-값의 쌍을 가지며 그 타입은 프로그래머가 선택한다. 맵,리듀스 함수를 각각 프로그래머가 작성해야 한다.

#### 2.3.2 자바 맵리듀스

- 테스트 수행

### 2.4 분산형으로 확장하기

#### 2.4.1 데이터 흐름

#### 2.4.2 컴바이너 함수

- 컴바이너 함수 작성하기

#### 2.4.3 분산 맵리듀스 잡 실행하기

### 2.5 하둡 스트리밍

#### 2.5.1 루비

#### 2.5.2 파이썬

